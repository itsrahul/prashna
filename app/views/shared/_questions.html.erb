<% content_for :js do -%>
  <%= javascript_include_tag 'question_reload', 'data-turbolinks-track': 'reload' %>
  <%= javascript_include_tag 'fetch_vote_onload', 'data-turbolinks-track': 'reload' %>
  <%= javascript_include_tag 'answer', 'data-turbolinks-track': 'reload' %>
  <%= javascript_include_tag 'comment', 'data-turbolinks-track': 'reload' %>
  <%= javascript_include_tag 'report_abuse', 'data-turbolinks-track': 'reload' %>
<% end -%>
<% @questions.each do |question| %>
<div class="card bg-light mb-3" style="max-width: 150rem;">
  <div class="card-header">      
    <h5 class="card-title"><%= link_to question.title.capitalize, question_path(question.id) %></h5>
  </div>
  <div class="card-body">
    <p class="card-text"><%= question.markdown_content %></p>
    <% if question.doc.attached? %>
      <p class="card-text">Click <%= link_to 'here', rails_blob_path(question.doc, disposition: "attachment") %> to download attached doc.</p>
    <% end %>
    <p class="card-text">
      <% if question.topics.exists? %>
        <% question.topics.each do |topic| %>
          <span class="btn btn-dark">
            <%= link_to topic.name , search_topic_path(topic.name) %>
          </span>
        <% end %>
      <% end %>
    <p class="card-text">
    <%#TODO: remove if statement later %>
    <% if question.published_at %>
      posted by <%= link_to question.user.name, search_user_path(question.user.id) %>
      about <%= question.published_ago %> ago
    </p>
    <% end  %>
    <p>
      <a class="btn btn-primary btn-sm" data-toggle="collapse" href="#collapseAnswers-<%= question.id%>" role="button" aria-expanded="false" aria-controls="collapseExample">
        Answers(<%= question.answers_count %>)
      </a>
      <a class="btn btn-primary btn-sm" data-toggle="collapse" href="#collapseComments-<%= question.id%>" role="button" aria-expanded="false" aria-controls="collapseExample">
        Comments(<%= question.comments_count %>)
      </a>
    </p>
    <div class="collapse" id="collapseAnswers-<%= question.id%>">
      <div class="card card-body">
          <div class="answer-list">
          <% @answers = question.answers.order(net_upvotes: :desc) %>
          <%= render partial: "shared/answers" %>
        </div>
      </div>
    </div>
    <div class="collapse" id="collapseComments-<%= question.id%>">
      <div class="card card-body">
        <div class="question-comment-list flex-container">
          <% @comments = question.comments %>
          <%= render partial: "shared/comments" %>
        </div>
      </div>
    </div>
    <p>
    <% if logged_in? %>
      <% if not question.user == current_user %>
        <a class="btn btn-primary btn-sm" data-toggle="collapse" href="#collapseGiveAnswers-<%= question.id%>" role="button" aria-expanded="false" aria-controls="collapseExample">
          Answer...
        </a>
      <% end %>
      <a class="btn btn-primary btn-sm" data-toggle="collapse" href="#collapseGiveComments-<%= question.id%>" role="button" aria-expanded="false" aria-controls="collapseExample">
        Comment...
      </a>
      <% if not question.user == current_user %>
        <a class="btn btn-sm btn-primary" data-toggle="modal" role="button" data-target="#modalReportAbuse-<%= question.id%>">
          Report
        </a>
      <% end %>

      <div class="collapse" id="collapseGiveAnswers-<%= question.id%>">
        <div class="card card-body">
          <div class="answer-result-question-<%= question.id%>" role="alert">
          </div>
          <%= form_with(model: question, url: question_answers_path(question.id), remote: true, method: :post, class: "form-inline my-2 my-lg-0" ) do |form| %>
            <div class="form-group answer-div" data-result="answer-result-question-<%= question.id%>">
              <%= form.text_area :answer, class: "form-control mr-sm-2 form-control-sm", placeholder: "Answer the question", autocomplete: "off" %>
              <%= form.submit "Answer", class: "btn btn-secondary btn-sm submit-answer" %>
            </div>
          <% end %>
        </div>
      </div>
      <div class="collapse" id="collapseGiveComments-<%= question.id%>">
        <div class="card card-body">
          <div class="comment-result-question-<%= question.id%>" role="alert">
          </div>
          <%= form_with(model: question, url: question_comments_path(question.id), remote: true, method: :post, class: "form-inline my-2 my-lg-0" ) do |form| %>
            <div class="form-group comment-div" data-result="comment-result-question-<%= question.id%>">
              <%= form.text_area :comment, class: "form-control mr-sm-2 form-control-sm submit-comment", placeholder: "Comment on question", autocomplete: "off" %>
              <%= form.submit "Comment", class: "btn btn-secondary btn-sm submit-comment-button" %>
            </div>
          <% end %>
        </div>
      </div>


      <div class="modal modalReportAbuse fade" id="modalReportAbuse-<%= question.id%>" tabindex="-1" role="dialog">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">Report Abuse</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <%= form_with(url: report_abuse_path("question", question.id), method: "get") do |f| %>
              <div class="modal-body">
                <div class="form-group">
                  <%= f.label :reason %>
                  <%= f.text_area :reason, class: "form-control"%>
                </div>
                <div class="report-abuse-result" role="alert"> </div>
              </div>
              <div class="modal-footer">
                <%= f.submit("Report Abuse", class: "btn btn-primary") %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      
    <% end %>
    </p>
  </div>
</div>
<% end %>
<br>
<% if @questions.respond_to?(:total_pages) %>
<center><%= will_paginate @questions, previous_label: "previous",  class: "flickr_pagination" %></center>
<% end %>